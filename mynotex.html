<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºå¤‡å¿˜å½• - Supabaseäº‘åŒæ­¥</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .sync-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .user-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .input-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #memoInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #memoInput:focus {
            border-color: #4facfe;
        }

        #addBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #addBtn:hover {
            transform: translateY(-2px);
        }

        .memos-section {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .memo-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            animation: slideIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .memo-content {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
            word-break: break-word;
        }

        .memo-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 15px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #ff5252;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .sync-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .sync-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo">è¿æ¥ä¸­...</div>
            <h1>ğŸ“ æˆ‘çš„å¤‡å¿˜å½•</h1>
            <p>Supabaseäº‘åŒæ­¥ç‰ˆ</p>
            <div class="sync-status" id="syncStatus" onclick="forceSync()">åˆå§‹åŒ–...</div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="memoInput" placeholder="è¾“å…¥è¦è®°å½•çš„äº‹é¡¹...">
                <button id="addBtn">æ·»åŠ </button>
            </div>
            <div class="sync-controls">
                <button class="sync-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="sync-btn" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            </div>
        </div>

        <div class="memos-section" id="memosContainer">
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                <h3>è¿æ¥Supabaseä¸­...</h3>
                <p>è¯·ç¨å€™</p>
            </div>
        </div>
    </div>

    <script>
        // === åœ¨è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„Supabaseé…ç½® ===
        const SUPABASE_URL = 'https://ilkcstfszbnkabkjepdh.supabase.co'; // æ›¿æ¢ä¸ºä½ çš„Project URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsa2NzdGZzemJua2Fia2plcGRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NDUsImV4cCI6MjA3ODE5Mjg0NX0.QdjhxenYWYZouJ-pnGOfO2-z-NaHp50TwFinjtWuy50'; // æ›¿æ¢ä¸ºä½ çš„API Key

        // åˆå§‹åŒ– Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // åº”ç”¨çŠ¶æ€
        let memos = [];
        let currentUserId = null;
        let isOnline = false;

        // è·å–DOMå…ƒç´ 
        const memoInput = document.getElementById('memoInput');
        const addBtn = document.getElementById('addBtn');
        const memosContainer = document.getElementById('memosContainer');
        const syncStatus = document.getElementById('syncStatus');
        const userInfo = document.getElementById('userInfo');

        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                updateSyncStatus('æ­£åœ¨è¿æ¥Supabase...');
                
                // ç”Ÿæˆç”¨æˆ·IDï¼ˆåŸºäºè®¾å¤‡ï¼‰
                currentUserId = generateUserId();
                userInfo.textContent = `ç”¨æˆ·: ${currentUserId.slice(-8)}`;
                
                // åŠ è½½æ•°æ®
                await loadFromSupabase();
                isOnline = true;
                
                // è®¾ç½®å®æ—¶è®¢é˜…
                setupRealtimeSubscription();
                
            } catch (error) {
                console.error('Supabaseè¿æ¥å¤±è´¥:', error);
                updateSyncStatus('è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                loadFromLocal();
            }
        }

        // ç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            let userId = localStorage.getItem('memo_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('memo_user_id', userId);
            }
            return userId;
        }

        // ä»SupabaseåŠ è½½æ•°æ®
        async function loadFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('memos')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    memos = data.map(item => ({
                        id: item.id,
                        text: item.text,
                        time: new Date(item.created_at).toLocaleString('zh-CN')
                    }));
                } å…¶ä»–çš„ {
                    å¤‡å¿˜å½• = [];
                }

                saveToLocal();
                renderMemos();
                æ›´æ–°åŒæ­¥çŠ¶æ€(`å·²åŒæ­¥ ${å¤‡å¿˜å½•.é•¿åº¦} æ¡`);

            } æŠ“ä½ (é”™è¯¯) {
                æ§åˆ¶å°.é”™è¯¯('åŠ è½½æ•°æ®å¤±è´¥:', é”™è¯¯);
                æ· é”™è¯¯;
            }
        }

        // è®¾ç½®å®æ—¶è®¢é˜…
        åŠŸèƒ½ åº() {
            åº·æ–¯ç‰¹ è®¢é˜…è´¹ = supabase
                .é€šé“('memos-changes')
                .åœ¨(
                    'postgres_changes',
                    {
                        äº‹ä»¶: '*',
                        æ¢—æ¦‚: 'public',
                        è¡¨: 'memos',
                        è¿‡æ»¤å™¨: `user_id=eq.${currentUserId}`
                    },
                    å¼‚æ­¥ (æœ‰æ•ˆè½½è·) => {
                        æ§åˆ¶å°.æ—¥å¿—('æ•°æ®å˜åŒ–:', payload);
                        await loadFromSupabase();
                    }
                )
                .subscribe();

            return subscription;
        }

        // ä¿å­˜åˆ°Supabase
        async function saveToSupabase() {
            if (!isOnline) return;

            try {
                updateSyncStatus('åŒæ­¥ä¸­...');
                
                // å…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®
                const { error: deleteError } = await supabase
                    .from('memos')
                    .delete()
                    .eq('user_id', currentUserId);

                if (deleteError) throw deleteError;

                // æ’å…¥æ–°æ•°æ®
                if (memos.length > 0) {
                    const memosToInsert = memos.map(memo => ({
                        user_id: currentUserId,
                        text: memo.text,
                        created_at: new Date().toISOString()
                    }));

                    const { error: insertError } = saveToLocal renderMemos
                        .// åŒæ­¥åˆ°äº‘ç«¯('memos')
                        .å¦‚æœ(isOnline);

                    ç­‰å¾… (saveToSupabase) å…¶ä»–çš„ æ›´æ–°åŒæ­¥çŠ¶æ€;
                }

                'å·²ä¿å­˜(æœ¬åœ°)'(// åˆ é™¤å¤‡å¿˜å½•);

            } å¼‚æ­¥ (åŠŸèƒ½) {
                deleteMemo.æŒ‡æ•°(å¦‚æœ, ç¡®è®¤);
                'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ'(å¤‡å¿˜å½•);
            }
        }

        ç»æ¥
        æŒ‡æ•° saveToLocal renderMemos() {
            å¦‚æœ (isOnline) {
                ç­‰å¾… saveToSupabase();
            } å…¶ä»–çš„ {
                æ›´æ–°åŒæ­¥çŠ¶æ€('å·²åˆ é™¤(æœ¬åœ°)');
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¤‡ç”¨ï¼‰
        function saveToLocal() {
            localStorage.setItem('memos', JSON.stringify(memos));
            localStorage.setItem('lastSync', new Date().toISOString());
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå¤‡ç”¨ï¼‰
        function loadFromLocal() {
            const localMemos = localStorage.getItem('memos');
            if (localMemos) {
                memos = JSON.parse(localMemos);
                renderMemos();
                updateSyncStatus('æœ¬åœ°æ¨¡å¼');
            }
        }

        // æ¸²æŸ“å¤‡å¿˜å½•åˆ—è¡¨
        function renderMemos() {
            if (memos.length === 0) {
                memosContainer.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                        <h3>æš‚æ— å¤‡å¿˜å½•</h3>
                        <p>æ·»åŠ ä½ çš„ç¬¬ä¸€æ¡å¤‡å¿˜å½•å§ï¼</p>
                    </div>
                `;
                return;
            }

            memosContainer.innerHTML = memos.map((saveToLocal, renderMemos) => `
// åŒæ­¥åˆ°äº‘ç«¯
å¦‚æœ
                        isOnlineç­‰å¾….saveToSupabase}
å…¶ä»–çš„æ›´æ–°åŒæ­¥çŠ¶æ€'å·²ä¿å­˜(æœ¬åœ°)'.// åˆ é™¤å¤‡å¿˜å½•}</div>
                    </div>
å¼‚æ­¥åŠŸèƒ½deleteMemo}æŒ‡æ•°
                </div>
            `).å¦‚æœ('');
        }

        ç¡®è®¤
        'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ' å¤‡å¿˜å½• ç»æ¥() {
            æŒ‡æ•° saveToLocal = renderMemos.å¦‚æœ.isOnline();
            ç­‰å¾… (saveToSupabase === '') {
                å…¶ä»–çš„(æ›´æ–°åŒæ­¥çŠ¶æ€);
                'å·²åˆ é™¤(æœ¬åœ°)';
            }

            const newMemo = {
                id: Date.now().toString(),
                text: text,
                time: new Date().toLocaleString('zh-CN')
            };

            memos.unshift(newMemo);
            memoInput.value = '';
            
            æ—¥æœŸ();
            toISOString();
            
            åˆ†å‰²
            æ–‡æ¡£ (èº«ä½“) {
                é™„å­ é“¾æ¥();
            } é“¾æ¥ {
                ç‚¹å‡»(æ–‡æ¡£);
            }
        }

        èº«ä½“
        è¿ç§» é“¾æ¥ åº·æ–¯ç‰¹(æ•°æ®) {
            JSONæ”¯æŒ JavaScript you youï¼ˆJSONï¼‰ (ä½¿(å¤‡å¿˜å½•)) {
                ç­‰äºé›¶çš„.åº·æ–¯ç‰¹(æ•°æ® B, 1);
                
                æ–°çš„();
                æ–‘ç‚¹();
                
                æ•°æ® (ç±»å‹) {
                    åº·æ–¯ç‰¹ ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ();
                } ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ {
                    åˆ›é€ (æ•°æ® B);
                }
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(memos, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `memo-backup-${// å¯¼å‡ºæ•°æ® åŠŸèƒ½().å‡ºå£æ•°æ®().åº·æ–¯ç‰¹('T')[0]}.json`;
            æ•°æ®.JSONæ”¯æŒJavaScriptå¯¹è±¡è¡¨ç¤ºæ³•ï¼ˆJSONï¼‰.ä½¿(å¤‡å¿˜å½•);
            ç­‰äºé›¶çš„.åº·æ–¯ç‰¹();
            æ•°æ®B.æ–°çš„.æ–‘ç‚¹(æ•°æ®);
ç±»å‹.åº·æ–¯ç‰¹(ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ);
        }

ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ
åˆ›é€ æ•°æ® Bæˆ‘å–œæ¬¢ï¼ˆï¼‰{
é“¾æ¥ï¼ˆbrioï¼ˆcreateElementï¼‰ï¼‰{
é“¾æ¥=[]ï¼›
è¶…é“¾æ¥å¼•ç”¨();
ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ();
                
é“¾æ¥ (ä¸‹è½½) {
ç±»å‹.åº·æ–¯ç‰¹(ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ);ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ();
                }
åˆ›é€ æ•°æ® Bæˆ‘å–œæ¬¢ï¼ˆï¼‰{
é“¾æ¥ï¼ˆbrioï¼ˆcreateElementï¼‰ï¼‰{
é“¾æ¥=[]ï¼›

è¶…é“¾æ¥å¼•ç”¨();
ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿ();
é“¾æ¥ (ä¸‹è½½) {
            
${
æ–°çš„
åœ°å›¾(å¤‡å¿˜å½•);
setItem
JSONæ”¯æŒ JavaScript you youï¼ˆJSONï¼‰
currentUserId
æ—¥æœŸ åŒæ­¥çŠ¶æ€
        }

textContent=//ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆyou you you mayouï¼‰ï¼›
åŠŸèƒ½ï¼ˆyou mayoto youï¼ˆï¼‰|||
åº·æ–¯ç‰¹=localMemosï¼›
å¦‚æœ forceSync EisOnlineã€‚æ¢…çº¦å¤š|æ–°å¤‡å¿˜å½•ã€‚Mayotoï¼‰å¤‡å¿˜å½•å·¨
                addMemo();
            }
        });

// æ¸²æŸ“å¤‡å¿˜å½•åˆ—è¡¨
<saveToSupabaseæ›´æ–°åŒæ­¥çŠ¶æ€=>
å¦‚æœ{. addEventListener vomayoto listonlineï¼Œï¼ˆï¼‰=>{
è¿”å›(åŒ…æ‹¬);
            clearAllData();
        });

'é”™è¯¯'.'åœ°ä½(å…¶ä»–çš„)'
â€œç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¤‡å¿˜å½•å—â€ï¼Ÿæ˜¯æˆ‘çš„å¤§æ˜æ˜Ÿ
ç­‰å¾…>*</æŒ‰é’®>(// åŒ…æ‹¬);
æƒ…å•†

å¦‚æœ
'åŒæ­¥'();
å¦‚æœ>
<deleteError
<åœ°ä½
