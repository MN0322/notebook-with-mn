<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—ºèœœå¤‡å¿˜å½• - äº‘åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; padding: 20px; 
        }
        .container { 
            max-width: 600px; margin: 0 auto; background: white; 
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; padding: 30px 20px; text-align: center; position: relative;
        }
        .sync-status {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.2); padding: 5px 10px;
            border-radius: 15px; font-size: 12px;
        }
        .input-section { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        #memoInput { 
            flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; 
            font-size: 16px; outline: none; 
        }
        #addBtn { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; 
            border: none; padding: 15px 25px; border-radius: 12px; font-size: 16px; 
            cursor: pointer; 
        }
        .memos-section { padding: 20px; max-height: 500px; overflow-y: auto; }
        .memo-item { 
            background: white; border: 1px solid #e9ecef; border-radius: 12px; 
            padding: 15px; margin-bottom: 15px; 
        }
        .sync-info { 
            background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 10px;
            border-left: 4px solid #4facfe;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æˆ‘çš„å¤‡å¿˜å½•</h1>
            <p>äº‘åŒæ­¥ç‰ˆæœ¬</p>
            <div class="sync-status" id="syncStatus">åˆå§‹åŒ–...</div>
        </div>
        
        <div class="input-section">
            <div class="sync-info" id="connectionInfo">
                æ­£åœ¨è¿æ¥äº‘æ•°æ®åº“...
            </div>
            
            <div class="input-group">
                <input type="text" id="memoInput" placeholder="è¾“å…¥è¦è®°å½•çš„äº‹é¡¹...">
                <button id="addBtn">æ·»åŠ </button>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="forceSync()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin: 0 5px;">å¼ºåˆ¶åŒæ­¥</button>
                <button onclick="clearAllData()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin: 0 5px;">æ¸…ç©ºæ•°æ®</button>
            </div>
        </div>

        <div class="memos-section" id="memosContainer">
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                <h3>åŠ è½½ä¸­...</h3>
                <p>æ­£åœ¨è¿æ¥äº‘æœåŠ¡</p>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½®åŒºåŸŸ ===
        // æ›¿æ¢ä¸ºä½ çš„ Supabase é…ç½®
        const SUPABASE_CONFIG = {
            url: 'https://ilkcstfszbnkabkjepdh.supabase.co', // ä½ çš„ Project URL
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsa2NzdGZzemJua2Fia2plcGRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NDUsImV4cCI6MjA3ODE5Mjg0NX0.QdjhxenYWYZouJ-pnGOfO2-z-NaHp50TwFinjtWuy50' // ä½ çš„ anon public key
        };

        // åº”ç”¨çŠ¶æ€
        let memos = [];
        let supabase = null;
        let currentUser = null;
        let isOnline = false;

        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                updateStatus('æ­£åœ¨åˆå§‹åŒ–...', 'loading');
                
                // åˆå§‹åŒ– Supabase
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true
                    }
                });

                // åˆ›å»ºåŒ¿åç”¨æˆ·
                const { data: authData, error: authError } = await supabase.auth.signInAnonymously();
                
                if (authError) {
                    throw new Error('è®¤è¯å¤±è´¥: ' + authError.message);
                }

                currentUser = authData.user;
                updateStatus('äº‘åŒæ­¥å·²è¿æ¥', 'success');
                isOnline = true;

                // åŠ è½½æ•°æ®
                await loadMemosFromCloud();
                
                // è®¾ç½®å®æ—¶ç›‘å¬
                setupRealtimeListener();

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('äº‘åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', 'error');
                loadMemosFromLocal();
            }
        }

        // ä»äº‘ç«¯åŠ è½½å¤‡å¿˜å½•
        async function loadMemosFromCloud() {
            try {
                const { data, error } = await supabase
                    .from('memos')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    memos = data.map(item => ({
                        id: item.id,
                        text: item.content,
                        time: new Date(item.created_at).toLocaleString('zh-CN')
                    }));
                    updateStatus(`å·²åŒæ­¥ ${memos.length} æ¡å¤‡å¿˜å½•`, 'success');
                } else {
                    memos = [];
                    updateStatus('æš‚æ— æ•°æ®', 'info');
                }

                saveToLocal();
                renderMemos();

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // è®¾ç½®å®æ—¶ç›‘å¬
        function setupRealtimeListener() {
            if (!supabase || !currentUser) return;

            const subscription = supabase
                .channel('memos-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'memos',
                        filter: `user_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        console.log('å®æ—¶æ›´æ–°:', payload);
                        loadMemosFromCloud(); // é‡æ–°åŠ è½½æ•°æ®
                    }
                )
                .subscribe();

            return subscription;
        }

        // æ·»åŠ å¤‡å¿˜å½•
        async function addMemo() {
            const text = document.getElementById('memoInput').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥å†…å®¹ï¼');
                return;
            }

            const newMemo = {
                text: text,
                time: new Date().toLocaleString('zh-CN')
            };

            // å…ˆæ›´æ–°æœ¬åœ°
            memos.unshift(newMemo);
            document.getElementById('memoInput').value = '';
            saveToLocal();
            renderMemos();

            // åŒæ­¥åˆ°äº‘ç«¯
            if (isOnline) {
                try {
                    const { error } = await supabase
                        .from('memos')
                        .insert([
                            {
                                user_id: currentUser.id,
                                content: text,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;
                    
                    updateStatus('å·²åŒæ­¥åˆ°äº‘ç«¯', 'success');
                } catch (error) {
                    console.error('åŒæ­¥å¤±è´¥:', error);
                    updateStatus('åŒæ­¥å¤±è´¥', 'error');
                }
            }
        }

        // åˆ é™¤å¤‡å¿˜å½•
        async function deleteMemo(index) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;

            const memo = memos[index];
            
            // å…ˆæ›´æ–°æœ¬åœ°
            memos.splice(index, 1);
            saveToLocal();
            renderMemos();

            // åŒæ­¥åˆ°äº‘ç«¯
            if (isOnline && memo.id) {
                try {
                    const { error } = await supabase
                        .from('memos')
                        .delete()
                        .eq('id', memo.id);

                    if (error) throw error;
                    
                    updateStatus('å·²ä»äº‘ç«¯åˆ é™¤', 'success');
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    updateStatus('åˆ é™¤å¤±è´¥', 'error');
                }
            }
        }

        // å¼ºåˆ¶åŒæ­¥
        async function forceSync() {
            if (isOnline) {
                await loadMemosFromCloud();
            } else {
                updateStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ— æ³•åŒæ­¥', 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;

            if (isOnline) {
                try {
                    const { error } = await supabase
                        .from('memos')
                        .delete()
                        .eq('user_id', currentUser.id);

                    if (error) throw error;
                } catch (error) {
                    console.error('æ¸…ç©ºå¤±è´¥:', error);
                updateStatus('æ¸…ç©ºå¤±è´¥', 'error');
                    return;
                }
            }

            memos = [];
            saveToLocal();
            renderMemos();
            updateStatus('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'success');
        }

        // æœ¬åœ°å­˜å‚¨ç›¸å…³å‡½æ•°
        function saveToLocal() {
            localStorage.setItem('memos', JSON.stringify(memos));
            localStorage.setItem('lastSync', new Date().toISOString());
        }

        function loadMemosFromLocal() {
            const localMemos = localStorage.getItem('memos');
            if (localMemos) {
                memos = JSON.parse(localMemos);
                renderMemos();
                updateStatus(`æœ¬åœ° ${memos.length} æ¡`, 'info');
            }
        }

        // æ¸²æŸ“å‡½æ•°
        function renderMemos() {
            const container = document.getElementById('memosContainer');
            
            if (memos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                        <h3>æš‚æ— å¤‡å¿˜å½•</h3>
                        <p>æ·»åŠ ä½ çš„ç¬¬ä¸€æ¡å¤‡å¿˜å½•å§ï¼</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = memos.map((memo, index) => `
                <div class="memo-item">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-size: 16px; line-height: 1.5;">${memo.text}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">${memo.time}</div>
                        </div>
                        <button onclick="deleteMemo(${index})" style="background: #ff6b6b; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-left: 15px;">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('syncStatus');
            const infoElement = document.getElementById('connectionInfo');
            
            statusElement.textContent = message;
            infoElement.innerHTML = `<strong>çŠ¶æ€:</strong> ${message}`;
            
            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            const colors = {
                success: 'rgba(0,255,0,0.3)',
                error: 'rgba(255,0,0,0.3)',
                loading: 'rgba(255,255,0,0.3)',
                info: 'rgba(255,255,255,0.2)'
            };
            
            statusElement.style.background = colors[type] || colors.info;
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('addBtn').addEventListener('click', addMemo);
        document.getElementById('memoInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMemo();
        });

        // å…¨å±€å‡½æ•°
        window.deleteMemo = deleteMemo;
        window.forceSync = forceSync;
        window.clearAllData = clearAllData;

        // å¯åŠ¨åº”ç”¨
        initApp();
    </script>
</body>
</html>
