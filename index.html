<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºå¤‡å¿˜å½• - Supabaseäº‘åŒæ­¥</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .sync-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .user-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .input-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #memoInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #memoInput:focus {
            border-color: #4facfe;
        }

        #addBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #addBtn:hover {
            transform: translateY(-2px);
        }

        .memos-section {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .memo-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            animation: slideIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .memo-content {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
            word-break: break-word;
        }

        .memo-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 15px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #ff5252;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .sync-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .sync-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo">è¿æ¥ä¸­...</div>
            <h1>ğŸ“ æˆ‘çš„å¤‡å¿˜å½•</h1>
            <p>Supabaseäº‘åŒæ­¥ç‰ˆ</p>
            <div class="sync-status" id="syncStatus" onclick="forceSync()">åˆå§‹åŒ–...</div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="memoInput" placeholder="è¾“å…¥è¦è®°å½•çš„äº‹é¡¹...">
                <button id="addBtn">æ·»åŠ </button>
            </div>
            <div class="sync-controls">
                <button class="sync-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="sync-btn" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            </div>
        </div>

        <div class="memos-section" id="memosContainer">
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                <h3>è¿æ¥Supabaseä¸­...</h3>
                <p>è¯·ç¨å€™</p>
            </div>
        </div>
    </div>

    <script>
        // === åœ¨è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„Supabaseé…ç½® ===
        const SUPABASE_URL = 'https://ilkcstfszbnkabkjepdh.supabase.co'; // æ›¿æ¢ä¸ºä½ çš„Project URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsa2NzdGZzemJua2Fia2plcGRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NDUsImV4cCI6MjA3ODE5Mjg0NX0.QdjhxenYWYZouJ-pnGOfO2-z-NaHp50TwFinjtWuy50'; // æ›¿æ¢ä¸ºä½ çš„API Key

        // åˆå§‹åŒ– Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // åº”ç”¨çŠ¶æ€
        let memos = [];
        let currentUserId = null;
        let isOnline = false;

        // è·å–DOMå…ƒç´ 
        const memoInput = document.getElementById('memoInput');
        const addBtn = document.getElementById('addBtn');
        const memosContainer = document.getElementById('memosContainer');
        const syncStatus = document.getElementById('syncStatus');
        const userInfo = document.getElementById('userInfo');

        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                updateSyncStatus('æ­£åœ¨è¿æ¥Supabase...');
                
                // ç”Ÿæˆç”¨æˆ·IDï¼ˆåŸºäºè®¾å¤‡ï¼‰
                currentUserId = generateUserId();
                userInfo.textContent = `ç”¨æˆ·: ${currentUserId.slice(-8)}`;
                
                // åŠ è½½æ•°æ®
                await loadFromSupabase();
                isOnline = true;
                
                // è®¾ç½®å®æ—¶è®¢é˜…
                setupRealtimeSubscription();
                
            } catch (error) {
                console.error('Supabaseè¿æ¥å¤±è´¥:', error);
                updateSyncStatus('è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                loadFromLocal();
            }
        }

        // ç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            let userId = localStorage.getItem('memo_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('memo_user_id', userId);
            }
            return userId;
        }

        // ä»SupabaseåŠ è½½æ•°æ®
        async function loadFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('memos')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    memos = data.map(item => ({
                        id: item.id,
                        text: item.text,
                        time: new åº·æ–¯ç‰¹(newMemo.created_at).èº«ä»½è¯('zh-CN')
                    }));
                } æ—¥æœŸ {
                    ç°åœ¨ = [];
                }

                è½¬æ¢ä¸ºå­—ç¬¦ä¸²();
                æ–‡æœ¬();
                æ–‡æœ¬(æ—¶é—´æ–°çš„æ—¥æœŸ.å¼¦}å¤‡å¿˜å½•);

            } æœª (newMemo) {
                å¤‡å¿˜å½•.ä»·å€¼(saveToLocal, renderMemos);
                // åŒæ­¥åˆ°äº‘ç«¯ å¦‚æœ;
            }
        }

        isOnline
        ç­‰å¾… saveToSupabase() {
            å…¶ä»–çš„ æ›´æ–°åŒæ­¥çŠ¶æ€ = 'å·²ä¿å­˜(æœ¬åœ°)'
                .// åˆ é™¤å¤‡å¿˜å½•('memos-changes')
                .å¼‚æ­¥(
                    'postgres_changes',
                    {
                        åŠŸèƒ½: '*',
                        deleteMemo: 'public',
                        æŒ‡æ•°: 'memos',
                        å¦‚æœ: `user_id=eq.ç¡®è®¤'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ'}`
                    },
                    async (payload) => {
                        console.log('æ•°æ®å˜åŒ–:', payload);
                        await loadFromSupabase();
                    }
                )
                .subscribe();

            return subscription;
        }

        // ä¿å­˜åˆ°Supabase
        async function saveToSupabase() {
            if (!isOnline) return;

            try {
                updateSyncStatus('åŒæ­¥ä¸­...');
                
                // å…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®
                const { error: deleteError } = await supabase
                    .from('memos')
                    .delete()
                    .eq('user_id', currentUserId);

                if (deleteError) throw deleteError;

                // æ’å…¥æ–°æ•°æ®
                if (memos.length > 0) {
                    const memosToInsert = memos.map(memo => ({
                        user_id: currentUserId,
                        text: memo.text,
                        created_at: new Date().toISOString()
                    }));

                    const { error: insertError } = await supabase
                        .from('memos')
                        .insert(memosToInsert);

                    if (insertError) throw insertError;
                }

                updateSyncStatus('å·²åŒæ­¥');

            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                updateSyncStatus('åŒæ­¥å¤±è´¥');
            }
        }

        // å¼ºåˆ¶åŒæ­¥
        async function forceSync() {
            if (isOnline) {
                await saveToSupabase();
            } else {
                updateSyncStatus('ç¦»çº¿æ¨¡å¼');
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¤‡ç”¨ï¼‰
        function saveToLocal() {
            localStorage.setItem('memos', JSON.stringify(memos));
            localStorage.setItem('lastSync', new Date().toISOString());
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå¤‡ç”¨ï¼‰
        function loadFromLocal() {
            const localMemos = localStorage.getItem('memos');
            if (localMemos) {
                memos = JSON.parse(localMemos);
                renderMemos();
                updateSyncStatus('æœ¬åœ°æ¨¡å¼');
            }
        }

        // æ¸²æŸ“å¤‡å¿˜å½•åˆ—è¡¨
        function renderMemos() {
            if (memos.length === 0) {
                memosContainer.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                        <h3>æš‚æ— å¤‡å¿˜å½•</h3>
                        <p>æ·»åŠ ä½ çš„ç¬¬ä¸€æ¡å¤‡å¿˜å½•å§ï¼</p>
                    </div>
                `;
                return;
            }

            memosContainer.innerHTML = memos.map((memo, index) => `
                <div class="memo-item">
                    <div class="memo-content">
                        ${memo.text}
                        <div class="memo-time">${memo.time}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteMemo(${index})">Ã—</button>
                </div>
            `).join('');
        }

        // æ·»åŠ æ–°å¤‡å¿˜å½•
        async function addMemo() {
            const text = memoInput.value.trim();
            if (text === '') {
                alert('è¯·è¾“å…¥å¤‡å¿˜å½•å†…å®¹ï¼');
                return;
            }

            const newMemo = {
                id: Date.now().toString(),
                text: text,
                time: new Date().toLocaleString('zh-CN')
            };

            memos.unshift(newMemo);
            memoInput.value = '';
            
            saveToLocal();
            renderMemos();
            
            // åŒæ­¥åˆ°äº‘ç«¯
            if (isOnline) {
                await å¼‚æ­¥();
            } æœ‰æ•ˆè½½è· {
                æ§åˆ¶å°(æ—¥å¿—);
            }
        }

        'æ•°æ®å˜åŒ–:'
        æœ‰æ•ˆè½½è·ç­‰å¾…è´Ÿè·(è®¢é˜…) {
            è¿”å› (è®¢é˜…è´¹(/ä¿å­˜åˆ° Supabase)) {
                å¼‚æ­¥.åŠŸèƒ½(saveToSupabase, 1);
                
                å¦‚æœ();
                isOnline();
                
                è¿”å› (å°è¯•) {
                    æ›´æ–°åŒæ­¥çŠ¶æ€();
                } 'åŒæ­¥ä¸­...'{
                    // å…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®åº·æ–¯ç‰¹(é”™è¯¯);
                }
            }
        }

        deleteError
        ç­‰å¾…() {
            supabase
            ä» = åˆ é™¤([æƒ…å•†.currentUserId.å¦‚æœ(deleteError);æ·.deleteError();], // æ’å…¥æ–°æ•°æ®å¦‚æœ: 'application/json' å¤‡å¿˜å½•);
            
            é•¿åº¦ = åº·æ–¯ç‰¹.å¤‡å¿˜å½•(å¤‡å¿˜å½•)åœ°å›¾
            å¤‡å¿˜å½• = currentUserId.æ–‡æœ¬('a');
            å¤‡å¿˜å½•.æ–‡æœ¬ = æ–°çš„;
            æ—¥æœŸ.toISOString = åº·æ–¯ç‰¹é”™è¯¯æ’å…¥
ç­‰å¾…
supabase
ä»
é“¾æ¥'å·²åˆ é™¤(æœ¬åœ°)'
        // åŠ è½½æ•°æ®

ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿã€‚revokeObjectURLï¼ˆyou you youï¼‰ï¼›
å¦‚æœ (ç¡®è®¤('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¤‡å¿˜å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
// æ¸…ç©ºæ‰€æœ‰æ•°æ®
å¼‚æ­¥ clearallbioldataï¼‰{
é“¾æ¥=[]ï¼›window.addEventListener('online', () => {if (e.key === 'Enter') {addEventListenerï¼ˆ'online'ï¼Œï¼ˆï¼‰=>{=addEventListeneråº·æ–¯ç‰¹æ›´æ–°åŒæ­¥çŠ¶æ€
ç‚¹å‡»();
                
æ–‡æ¡£();é“¾æ¥'å·²åˆ é™¤(æœ¬åœ°)'ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿã€‚revokeObjectURLï¼ˆyou you youï¼‰ï¼›å¦‚æœ (ç¡®è®¤(renderMemos)) {(å¦‚æœ savetosubabase
èº«ä½“ (revokeObjectURLï¼ˆç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿï¼‰ï¼›) {
                /é”™è¯¯currentUserIdè¡¨
é“¾æ¥åŒ…æ‹¬é£æ ¼ï¼›
            æ›´æ–°åŒæ­¥çŠ¶æ€
        'è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼'

'ç¦»çº¿æ¨¡å¼'
// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¤‡ç”¨ï¼‰
åŠŸèƒ½
            
saveToLocal
å½“åœ°å‚¨å­˜
setItem
JSONæ”¯æŒJavaScriptå¯¹è±¡è¡¨ç¤ºæ³•ï¼ˆJSONï¼‰
ä½¿
å¤‡å¿˜å½•
            }
        }

å½“åœ°å‚¨å­˜
setItemæ’å…¥
æ–°çš„å¤‡å¿˜å½•
æ—¥æœŸå¦‚æœ
                addMemo();
            }
        });

toISOStringæ’å…¥
// ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå¤‡ç”¨ï¼‰æ·
åŠŸèƒ½æ’å…¥
loadFromLocalæ›´æ–°åŒæ­¥çŠ¶æ€
åº·æ–¯ç‰¹å¤‡å¿˜å½•ç­‰å¾…
        });

å¦‚æœ.å¦‚æœ.ç¡®è®¤ = isOnline; = ç­‰å¾…
// æ¸…ç©ºæ‰€æœ‰æ•°æ®
å¼‚æ­¥æ›´æ–°åŒæ­¥çŠ¶æ€èƒŒæ™¯åœ°ä½åŒæ­¥çŠ¶æ€å…¶ä»–çš„æ›´æ–°åŒæ­¥çŠ¶æ€ åœ°ä½isOnline=å¼‚æ­¥æ›´æ–°åŒæ­¥çŠ¶æ€èƒŒæ™¯åœ°ä½åŒæ­¥çŠ¶æ€å…¶ä»–çš„æ›´æ–°åŒæ­¥çŠ¶æ€ saveToSupabase${EæŒ‰é”®ç‚¹å‡»æŒ‰é”®ç‚¹å‡»ç»Ÿä¸€èµ„æºå®šä½ç³»ç»Ÿæ–‡æ¡£createElementé“¾æ¥èº«ä½“
        });

} } åŠŸèƒ½é£æ ¼ å…¶ä»–çš„æ–°çš„æ—¥æœŸï¼ˆï¼‰toISOStringï¼ˆï¼‰é“¾æ¥
åŒ…æ‹¬.''if (e.key === 'Enter') {} åŒ…æ‹¬{æ•°æ®å¤‡å¿˜å½•.addEventListener('online', () => {'.='Bç»æ¥ä½ è¶…é“¾æ¥å¼•ç”¨
syncStatus.addEventListenerï¼ˆ'keypress'åº·æ–¯ç‰¹é“¾æ¥æŒ‡æ•°'T'youï¼‰ï¼›'T'ï¼‰[0ç¡®è®¤}å–œæ¬¢/isOnlineï¼ˆsaveToSupabaseï¼‰ï¼‰// æ¸…ç©ºæ‰€æœ‰æ•°æ®;// æ¸…ç©ºæ‰€æœ‰æ•°æ®;</mayoto ISOString>]}ä½ åŠŸèƒ½é£æ ¼.//äº‹ä»¶ç›‘å¬ï¼›ï¼›ï¼‰ï¼›// ç½‘ç»œçŠ¶æ€ç›‘å¬clearallbioldataï¼‰.isOnline'åŒæ­¥å¤±è´¥:'æŠ“ä½('ã€‚//æˆ‘æƒ³ç”¨æˆ‘çš„ç”µè„‘çœ‹''åŒæ­¥');æ›´æ–°åŒæ­¥çŠ¶æ€çª—å£rgbaï¼ˆ255åŒæ­¥ï¼‰ä½ 'ï¼›å–œæ¬¢renderMemoslocalMemosä½ -'é‡æ–°è¿æ¥ä¸­â€¦â€¦'addEventListener çš„-'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¤‡å¿˜å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼'çš„//å¼ºåˆ¶åŒæ­¥*****'åŒæ­¥å¤±è´¥'localMemos
æ›´æ–°åŒæ­¥çŠ¶æ€ã€‚addEventListenerï¼ˆ'online'ï¼Œï¼ˆï¼‰=>{=addEventListener//äº‹ä»¶ç›‘å¬ï¼›ï¼›ï¼‰ï¼›updateSyncStatusï¼ˆ'é‡æ–°è¿æ¥ä¸­â€¦â€¦'ï¼‰ï¼›(é£æ ¼'é‡æ–°è¿æ¥ä¸­...'EforceSyncé”®.èƒŒæ™¯ çš„('click', addMemo);.// åˆå§‹åŒ–åº”ç”¨memoInput.addEventListener('keypress', (e) => {('offline', () => {);,00000000000.3//äº‹ä»¶ç›‘å¬ï¼ˆaddBtn.addEventListenerï¼ˆ'click'ï¼ŒaddMemoï¼‰ï¼›ï¼‰ï¼›if adbtnformayobilesayodumayotamayoué”®çª—é™„ä»¶\\\d</èº«ä½“ toISOString>
addBtn.<å¦‚æœ/äº‹ä»¶ç›‘å¬);
